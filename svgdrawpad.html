<html> 
<head>
<title>DrawPad</title>

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">

<!-- jQuery library -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<!-- Latest compiled JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script> 
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/1.6.4/fabric.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pdfkit@0.10.0/js/pdfkit.standalone.js"></script>
<script src="https://bundle.run/blob-stream@0.1.3"></script>
<script src="https://cdn.jsdelivr.net/npm/svg-to-pdfkit@0.1.8/source.js"></script>

<!-- Import Local JS files-->
<script src="src/actions.js"></script>
<script src="src/pages.js"></script>
<script src="src/penActions.js"></script>
<link rel="stylesheet" href="css/style.css">


</head>

<body>
    
    <nav class="no-border navbar navbar-inverse" onclick="forceStop()">
        <div class="container-fluid">
            <div class="navbar-header">
            <a class="navbar-brand unselectable">DrawPad</a>
            </div>
            <ul class="nav navbar-nav">
                <li id="clearArealabel" onclick="clearArea()"><a title="Clear" class="unselectable"><span  class="unselectable glyphicon glyphicon-erase"></a></li>
                <li id="changePenColourlabel"><a id="penColour" title="Colour" class="dropdown-toggle" data-toggle="dropdown"><span  class="unselectable glyphicon glyphicon-certificate large"></span></a>
                    <div class="dropdown-menu bracket" style="background:#222222;" id="m-target-1">

                        
                        <canvas id="colorCanvas" class="color-canvas bracket" width="250" height="250"></canvas>
                        <button style="border: #000000;background: #ffffff;height: 15px;width: 15px;" onclick="changePenColour('#ffffff')"></button>
                        <button style="border: #000000;background: #000000;height: 15px;width: 15px;" onclick="changePenColour('#000000')"></button>
                        <button style="border: #000000;background: #ff0000;height: 15px;width: 15px;" onclick="changePenColour('#ff0000')"></button>
                        <button style="border: #000000;background: #ffa500;height: 15px;width: 15px;" onclick="changePenColour('#ffa500')"></button>
                        <button style="border: #000000;background: #ffff00;height: 15px;width: 15px;" onclick="changePenColour('#ffff00')"></button>
                        <button style="border: #000000;background: #00ff00;height: 15px;width: 15px;" onclick="changePenColour('#00ff00')"></button>
                        <button style="border: #000000;background: #0000ff;height: 15px;width: 15px;" onclick="changePenColour('#0000ff')"></button>
                        <button style="border: #000000;background: #4b0082;height: 15px;width: 15px;" onclick="changePenColour('#4b0082')"></button>
                        <button style="border: #000000;background: #8a2be2;height: 15px;width: 15px;" onclick="changePenColour('#8a2be2')"></button>
                        <button style="border: #000000;background: #a52a2a;height: 15px;width: 15px;" onclick="changePenColour('#a52a2a')"></button>
                        <button style="border: #000000;background: #deb887;height: 15px;width: 15px;" onclick="changePenColour('#deb887')"></button>
                        <button style="border: #000000;background: #5f9ea0;height: 15px;width: 15px;" onclick="changePenColour('#5f9ea0')"></button>
                        <button style="border: #000000;background: #7fff00;height: 15px;width: 15px;" onclick="changePenColour('#7fff00')"></button>
                    </div>
                </li>
                <li id="changePenActionlabel"><a title="Pen Mode" id="penAction" class="dropdown-toggle" data-toggle="dropdown"><span  class="glyphicon glyphicon-pencil large" id="changepenbutton"></span></a>
                    <ul class="dropdown-menu">
                        <li><a class="unselectable verticle-centre" id="a" onclick="changePenAction('pen')"><span class="glyphicon glyphicon-pencil"></span> - Pen</a></li>
                        <li><a class="unselectable verticle-centre" id="a" onclick='changePenAction("line")'><span class="glyphicon glyphicon-resize-horizontal"></span> - Line</a></li>
                        <li><a class="unselectable verticle-centre" id="a" onclick='changePenAction("circle")'><span class="unselectable large">O</span> - Circle</a></li>
                        <li><a class="unselectable verticle-centre" id="a" onclick='changePenAction("rectangle")'><span class="glyphicon glyphicon-stop"></span> - Rectangle</a></li>
                        <li><a class="unselectable verticle-centre" id="a" onclick='changePenAction("text")'><span class="glyphicon glyphicon-text-background"></span> - Text</a></li>
                    </ul>
                </li>
                
                <!-- fill option-->
                <li id="changePenFillLabel" onclick="changePenFill()"><a title="Fill" class="unselectable"><span class="unselectable glyphicon glyphicon-adjust"><span class="unselectable glyphicon glyphicon-remove"></span></a></li>
                
                <!-- Extend Page-->
                <li id="extendPageLabel" onclick="extendPage()"><a title="Extend Page" class="unselectable"><span class="unselectable glyphicon glyphicon-triangle-bottom"></a></li>
                
                <!-- Stroke Width Dropdown-->
                <li id="changePenWidthLabel"><a title="Stroke Width" class="dropdown-toggle" data-toggle="dropdown"><span  class="glyphicon glyphicon-tint large unselectable" id="changepenWidthbutton">2</span></a>
                    <ul class="dropdown-menu">
                        <div class="slidecontainer">
                            <input oninput="changePenWidth()" type="range" min="1" max="100" value="2" class="slider" id="widthRange">
                        </div>
                    </ul>
                </li>

            </ul>


            <!-- NAVBAR RIGHT-->
            <ul class="nav navbar-nav navbar-right">
                <li id="pdflabel" onclick="downloadPDF()"><a title="Get PDF" class="unselectable"><span  class="unselectable glyphicon glyphicon-save"></a></li>
                <li><a id="pageNumber" class="unselectable">Page 1 of 5</a></li>
                <li title="Previous Page" onclick="gobackPage()"><a class="unselectable"><span class="glyphicon glyphicon-arrow-left large"></span></a></li>
                <li title="Next Page" onclick="advancePage()"><a class="unselectable"><span class="glyphicon glyphicon-arrow-right large"></span></a></li>  
            </ul>

        </div>
    </nav>
    <div id="svgholder" class="displayDiv">
        <svg id="svg" height="20000" class="canvas unselectable">
            
        </svg>
    </div>

</body>
<script>
let svg = document.getElementById("svg");

let penAction = "pen"; // defines the current pen action
var counter = 0 // Defines the current item number
var colour = "#ffffff"; // Defines the current colour
var pensize = 2; // Defines the current pen size
var prevX = 0; // Defines the previous x position
var currX = 0; // Defines the current x position
var prevY = 0; // Defines the previous y position
var currY = 0; // Defines the current y position
var flag = false; // Defines if the mouse is down or not
var fillShape = false; // Defines if the shape should be filled or not

var scrollableDiv = document.getElementById("svgholder");

function disableScroll() {
    scrollableDiv.classList.add("noScroll");
}

function enableScroll() {
    scrollableDiv.classList.remove("noScroll");
}

$(document).ready(function() {
    w = svg.width;
    h = svg.height;
    document.getElementById("pageNumber").innerHTML = "Page " + pageNumber + " of " + maxPage;
    //sets height of svg to div height
    svg.setAttribute("height", $("#svgholder").height());
    svg.setAttribute("width", $("#svgholder").width());
    defaultHeight = $("#svgholder").height();

    svg.addEventListener("pointermove", function(e) {
        e.preventDefault();
        findxy('move', e)
    }, false);
    svg.addEventListener("pointerdown", function(e) {
        e.preventDefault();
        if (e.pointerType === "pen") {
            disableScroll();
        } else {
            enableScroll();
        }
        if (e.button === 0) {
            findxy('down', e)
        }
    }, false);
    svg.addEventListener("pointerup", function(e) {
        resizeFlag = false;
        e.preventDefault();
        findxy('up', e)
        if (e.pointerType === "pen") {
            enableScroll();
        } 
    }, false);
    svg.addEventListener("touchend", function(e) {
        e.preventDefault();
    }, false);
    // Enable scroll when pointer is not on the svg
    svg.addEventListener("pointerleave", function(e) {
        enableScroll();
        if (penAction === "move" || penAction === "moveNoResizer") {
            findxy('up', e)
        }
    }, false);
});

function initColorPicker() {
  var canvas = document.getElementById('colorCanvas');
  var canvasContext = canvas.getContext('2d');

  let gradient = canvas.getContext('2d').createLinearGradient(0, 0, canvas.width, 0)
  gradient.addColorStop(0, '#ff0000')
  gradient.addColorStop(1 / 6, '#ffff00')
  gradient.addColorStop((1 / 6) * 2, '#00ff00')
  gradient.addColorStop((1 / 6) * 3, '#00ffff')
  gradient.addColorStop((1 / 6) * 4, '#0000ff')
  gradient.addColorStop((1 / 6) * 5, '#ff00ff')
  gradient.addColorStop(1, '#ff0000')
  canvas.getContext('2d').fillStyle = gradient
  canvas.getContext('2d').fillRect(0, 0, canvas.width, canvas.height)

  gradient = canvas.getContext('2d').createLinearGradient(0, 0, 0, canvas.height)
  gradient.addColorStop(0, 'rgba(255, 255, 255, 1)')
  gradient.addColorStop(0.5, 'rgba(255, 255, 255, 0)')
  gradient.addColorStop(1, 'rgba(255, 255, 255, 0)')
  canvas.getContext('2d').fillStyle = gradient
  canvas.getContext('2d').fillRect(0, 0, canvas.width, canvas.height)

  gradient = canvas.getContext('2d').createLinearGradient(0, 0, 0, canvas.height)
  gradient.addColorStop(0, 'rgba(0, 0, 0, 0)')
  gradient.addColorStop(0.5, 'rgba(0, 0, 0, 0)')
  gradient.addColorStop(1, 'rgba(0, 0, 0, 1)')
  canvas.getContext('2d').fillStyle = gradient
  canvas.getContext('2d').fillRect(0, 0, canvas.width, canvas.height)


  canvas.onclick = function(e) {
  	console.log()
    var imgData = canvasContext.getImageData((e.offsetX / canvas.clientWidth) * canvas.width, (e.offsetY / canvas.clientHeight) * canvas.height, 1, 1)
    var rgba = imgData.data;
    var colourGet = "rgba(" + rgba[0] + ", " + rgba[1] + ", " + rgba[2] + ", " + rgba[3] + ")";
    changePenColour(rgba2hex(colourGet));
  }
}

initColorPicker()

function rgba2hex(colour) {
    const rgba = colour.replace(/^rgba?\(|\s+|\)$/g, '').split(',');

    return `#${((1 << 24) + (parseInt(rgba[0]) << 16) + (parseInt(rgba[1]) << 8) + parseInt(rgba[2])).toString(16).slice(1)}`;
}

</script>
</html> 