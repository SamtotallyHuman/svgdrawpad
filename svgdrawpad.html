<html> 
<head>
<title>DrawPad</title>

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">

<!-- jQuery library -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<!-- Latest compiled JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script> 
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/1.6.4/fabric.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pdfkit@0.10.0/js/pdfkit.standalone.js"></script>
<script src="https://bundle.run/blob-stream@0.1.3"></script>
<script src="https://cdn.jsdelivr.net/npm/svg-to-pdfkit@0.1.8/source.js"></script>
</head>
<style>

.no-border {
    border: none;
}
nav
{
   position: fixed;
   top: 0px;
}
body {
    height: 100%;
    overflow-y: hidden;
    overflow-x: hidden;
    background-color: #222222;
    touch-action: none;
}
.canvas {
    background-color: #000000;
    touch-action: none;
    
}
.unselectable {
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}
.large-text {
    font-size: 30px;
}
.bracket {
    background-color: #000000;
}
.verticle-centre {
    vertical-align: middle;
}
.displayDiv {
    height: 100%;
    width: 100%;
    overflow: auto;
    touch-action: none;
    scroll-behavior: auto;
    -webkit-overflow-scrolling: touch;
}
.createdObject{
    touch-action: none;
}
.noScroll {
    overflow: hidden;
}
.slidecontainer {
  width: 100%; /* Width of the outside container */
}

/* The slider itself */
.slider {
  -webkit-appearance: none;  /* Override default CSS styles */
  appearance: none;
  width: 100%; /* Full-width */
  height: 10px; /* Specified height */
  background: #d3d3d3; /* Grey background */
  outline: none; /* Remove outline */
  opacity: 0.7; /* Set transparency (for mouse-over effects on hover) */
  -webkit-transition: .2s; /* 0.2 seconds transition on hover */
  transition: opacity .2s;
}

/* Mouse-over effects */
.slider:hover {
  opacity: 1; /* Fully shown on mouse-over */
}

/* The slider handle (use -webkit- (Chrome, Opera, Safari, Edge) and -moz- (Firefox) to override default look) */
.slider::-webkit-slider-thumb {
  -webkit-appearance: none; /* Override default look */
  appearance: none;
  width: 25px; /* Set a specific slider handle width */
  height: 25px; /* Slider handle height */
  background: #04AA6D; /* Green background */
  cursor: pointer; /* Cursor on hover */
}

.slider::-moz-range-thumb {
  width: 25px; /* Set a specific slider handle width */
  height: 25px; /* Slider handle height */
  background: #04AA6D; /* Green background */
  cursor: pointer; /* Cursor on hover */
}
.lowHeight {
    height: 10px;
}
</style>

<body>
    
    <nav class="no-border navbar navbar-inverse" onclick="forceStop()">
        <div class="container-fluid">
            <div class="navbar-header">
            <a class="navbar-brand unselectable">DrawPad</a>
            </div>
            <ul class="nav navbar-nav">
                <li id="clearArealabel" onclick="clearArea()"><a title="Clear" class="unselectable"><span  class="unselectable glyphicon glyphicon-erase"></a></li>
                <li id="changePenColourlabel"><a id="penColour" title="Colour" class="dropdown-toggle" data-toggle="dropdown"><span  class="unselectable glyphicon glyphicon-certificate large"></span></a>
                    <div class="dropdown-menu bracket" style="background:#222222;" id="m-target-1">

                        
                        <canvas id="colorCanvas" class="color-canvas bracket" width="250" height="250"></canvas>
                        <button style="border: #000000;background: #ffffff;height: 15px;width: 15px;" onclick="changePenColour('#ffffff')"></button>
                        <button style="border: #000000;background: #000000;height: 15px;width: 15px;" onclick="changePenColour('#000000')"></button>
                        <button style="border: #000000;background: #ff0000;height: 15px;width: 15px;" onclick="changePenColour('#ff0000')"></button>
                        <button style="border: #000000;background: #ffa500;height: 15px;width: 15px;" onclick="changePenColour('#ffa500')"></button>
                        <button style="border: #000000;background: #ffff00;height: 15px;width: 15px;" onclick="changePenColour('#ffff00')"></button>
                        <button style="border: #000000;background: #00ff00;height: 15px;width: 15px;" onclick="changePenColour('#00ff00')"></button>
                        <button style="border: #000000;background: #0000ff;height: 15px;width: 15px;" onclick="changePenColour('#0000ff')"></button>
                        <button style="border: #000000;background: #4b0082;height: 15px;width: 15px;" onclick="changePenColour('#4b0082')"></button>
                        <button style="border: #000000;background: #8a2be2;height: 15px;width: 15px;" onclick="changePenColour('#8a2be2')"></button>
                        <button style="border: #000000;background: #a52a2a;height: 15px;width: 15px;" onclick="changePenColour('#a52a2a')"></button>
                        <button style="border: #000000;background: #deb887;height: 15px;width: 15px;" onclick="changePenColour('#deb887')"></button>
                        <button style="border: #000000;background: #5f9ea0;height: 15px;width: 15px;" onclick="changePenColour('#5f9ea0')"></button>
                        <button style="border: #000000;background: #7fff00;height: 15px;width: 15px;" onclick="changePenColour('#7fff00')"></button>
                    </div>
                </li>
                <li id="changePenActionlabel"><a title="Pen Mode" id="penAction" class="dropdown-toggle" data-toggle="dropdown"><span  class="glyphicon glyphicon-pencil large" id="changepenbutton"></span></a>
                    <ul class="dropdown-menu">
                        <li><a class="unselectable verticle-centre" id="a" onclick="changePenAction('pen')"><span class="glyphicon glyphicon-pencil"></span> - Pen</a></li>
                        <li><a class="unselectable verticle-centre" id="a" onclick='changePenAction("line")'><span class="glyphicon glyphicon-resize-horizontal"></span> - Line</a></li>
                        <li><a class="unselectable verticle-centre" id="a" onclick='changePenAction("circle")'><span class="unselectable large">O</span> - Circle</a></li>
                        <li><a class="unselectable verticle-centre" id="a" onclick='changePenAction("rectangle")'><span class="glyphicon glyphicon-stop"></span> - Rectangle</a></li>
                        <li><a class="unselectable verticle-centre" id="a" onclick='changePenAction("text")'><span class="glyphicon glyphicon-text-background"></span> - Text</a></li>
                    </ul>
                </li>
                
                <!-- fill option-->
                <li id="changePenFillLabel" onclick="changePenFill()"><a title="Fill" class="unselectable"><span class="unselectable glyphicon glyphicon-adjust"><span class="unselectable glyphicon glyphicon-remove"></span></a></li>
                
                <!-- Extend Page-->
                <li id="extendPageLabel" onclick="extendPage()"><a title="Extend Page" class="unselectable"><span class="unselectable glyphicon glyphicon-triangle-bottom"></a></li>
                
                <!-- Stroke Width Dropdown-->
                <li id="changePenWidthLabel"><a title="Stroke Width" class="dropdown-toggle" data-toggle="dropdown"><span  class="glyphicon glyphicon-tint large unselectable" id="changepenWidthbutton">2</span></a>
                    <ul class="dropdown-menu">
                        <div class="slidecontainer">
                            <input oninput="changePenWidth()" type="range" min="1" max="100" value="2" class="slider" id="widthRange">
                        </div>
                    </ul>
                </li>

            </ul>


            <!-- NAVBAR RIGHT-->
            <ul class="nav navbar-nav navbar-right">
                <li id="pdflabel" onclick="downloadPDF()"><a title="Get PDF" class="unselectable"><span  class="unselectable glyphicon glyphicon-save"></a></li>
                <li><a id="pageNumber" class="unselectable">Page 1 of 5</a></li>
                <li title="Previous Page" onclick="gobackPage()"><a class="unselectable"><span class="glyphicon glyphicon-arrow-left large"></span></a></li>
                <li title="Next Page" onclick="advancePage()"><a class="unselectable"><span class="glyphicon glyphicon-arrow-right large"></span></a></li>  
            </ul>

        </div>
    </nav>
    <div id="svgholder" class="displayDiv">
        <svg id="svg" height="20000" class="canvas unselectable">
            
        </svg>
    </div>

</body>
<script>
let svg = document.getElementById("svg");
let penAction = "pen";

let items = [];

var counter = 0
var colour = "#ffffff";
var pensize = 2;
var prevX = 0;
var currX = 0;
var prevY = 0;
var currY = 0;
var flag = false;
var dot_flag = false;
var fillShape = false;
var defaultHeight = 0;

var pageNumber = 1;
var pageContents = [];
var maxPage = 1;
var pageHeight = [];

function changePenWidth() {
    pensize = document.getElementById("widthRange").value;
    document.getElementById("changepenWidthbutton").innerHTML = pensize;
}

var CLIPBOARD = new CLIPBOARD_CLASS(true);

/**
 * image pasting into canvas
 * 
 * @param {boolean} autoresize - if canvas will be resized
 */
function CLIPBOARD_CLASS(autoresize) {
    var _self = this;

    //handlers
    document.addEventListener('paste', function(e) {
        _self.paste_auto(e);
    }, false);

    //on paste
    this.paste_auto = function(e) {
        if (e.clipboardData) {
        var items = e.clipboardData.items;
        if (!items) return;

        //access data directly
        for (var i = 0; i < items.length; i++) {
            if (items[i].type.indexOf("image") !== -1) {
            //image
            var blob = items[i].getAsFile();
            var URLObj = window.URL || window.webkitURL;
            var source = URLObj.createObjectURL(blob);
            this.paste_createImage(source);
            }
        }
        e.preventDefault();
        }
    };
    //draw pasted image to svg
    this.paste_createImage = function(source) {
        var pastedImage = new Image();
        pastedImage.onload = function() {
            var clipboardCanvas = document.createElement("canvas")
            // set dimensions of canvas
            clipboardCanvas.width = pastedImage.width;
            clipboardCanvas.height = pastedImage.height;
            var context = clipboardCanvas.getContext("2d")
            context.drawImage(pastedImage, 0, 0, pastedImage.width, pastedImage.height);
            var dataurl = clipboardCanvas.toDataURL("image/png")

            var img = document.createElementNS('http://www.w3.org/2000/svg','image');
            img.setAttributeNS(null,'height',pastedImage.height);
            img.setAttributeNS(null,'width',pastedImage.width);
            img.setAttributeNS(null,'id',counter);
            img.setAttributeNS('http://www.w3.org/1999/xlink','href',dataurl);
            img.setAttributeNS(null,'x','0');
            img.setAttributeNS(null,'y','0');
            img.setAttributeNS(null,'preserveAspectRatio','none');
            $('#svg').append(img);
            
            counter++;
            var resizer = document.getElementById("resizer");
            if (resizer != null) {
                resizer.remove();
            }
            changePenAction("move");

        };
        pastedImage.src = source;
    };
}

function downloadPDF() {
    changePenAction('pen');
    updatePageContents();
    let doc = new PDFDocument({ 
        compress: false,
        autoFirstPage: false
    });
    
    // Loops through all svgs and adds them to a page
    for (let i = 1; i <= maxPage; i++) {
        pageNumber = i;
        updatePage();
        doc.addPage({
            size: [0.75*$("#svg").width(),0.75*$("#svg").height()],
            margin: 0
        });
        doc.rect(0, 0, $("#svg").width(), $("#svg").height()).fill('#000000');
        SVGtoPDF(doc, svg, 0, 0);
    }

    let stream = doc.pipe(blobStream());
    stream.on('finish', () => {
      let blob = stream.toBlob('application/pdf');
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = "svgDrawPadImage" + ".pdf";
      link.click();
    });
    doc.end();
}

function updatePage()
{
    document.getElementById("pageNumber").innerHTML = "Page " + pageNumber + " of " + maxPage;
    document.getElementById("svg").innerHTML = pageContents[pageNumber];
    if (pageHeight[pageNumber] != undefined)
    {
        svg.setAttribute("height", pageHeight[pageNumber]);
    }
    else
    {
        svg.setAttribute("height", defaultHeight);
    }
}

function updatePageContents() {
    if (penAction == "move")
    {
        changePenAction("pen");
    }
    pageContents[pageNumber] = svg.innerHTML;
    pageHeight[pageNumber] = $("#svg").height();
}

// Changes the page state
function advancePage() {
    updatePageContents();
    if (pageNumber < maxPage) {
        pageNumber++;
        updatePage();
        
    } else {
        maxPage++;
        pageNumber++;
        updatePage();
    }
}

function gobackPage() {
    updatePageContents();
    if (pageNumber > 1) {
        pageNumber--;
        updatePage();
    }
}

function extendPage() {
    var svgHeight = svg.getAttribute("height");
    svgHeight = parseInt(svgHeight) + 540;
    svg.setAttribute("height", svgHeight);
}

function changePenFill() {
    if (fillShape) {
        fillShape = false;
        document.getElementById("changePenFillLabel").innerHTML = "<a class='unselectable'><span class='unselectable glyphicon glyphicon-adjust'><span class='unselectable glyphicon glyphicon-remove'></a>";
    } else {
        fillShape = true;
        document.getElementById("changePenFillLabel").innerHTML = "<a class='unselectable'><span class='unselectable glyphicon glyphicon-adjust'><span class='unselectable glyphicon glyphicon-ok'></a>";
    }
}

function clearArea() {
    svg.innerHTML = "";
    items = [];
    counter = 0;
    console.log(fillShape);
}

function changePenColour(colourInput) {
    colour=colourInput;
    document.getElementById('penColour').style.color = colour;
}

function forceStop() {
    enableScroll();
    if (flag) {
        flag = false;
        dot_flag = false;
        counter++;
    }
}

function changeImageResizerPos() {
    console.log("changeImageResizerPos");
    var resizer = document.getElementById("resizer");
    resizer.setAttribute("cx",  document.getElementById(counter).getAttribute("x"));
    resizer.setAttribute("cy",  document.getElementById(counter).getAttribute("y"));
}

function changePenAction(action) {
    penAction = action;
    if (penAction == "pen") {
        document.getElementById('penAction').innerHTML = '<span class="glyphicon glyphicon-pencil large" id="changepenbutton"></span>';
    } else if (penAction == "fill") {
        document.getElementById('penAction').innerHTML = '<span class="glyphicon glyphicon-tint large" id="changepenbutton"></span>';
    } else if (penAction == "line") {
        document.getElementById('penAction').innerHTML = '<span class="glyphicon glyphicon-resize-horizontal large" id="changepenbutton"></span>';
    } else if (penAction == "circle") {
        document.getElementById('penAction').innerHTML = '<span class="unselectable large">O</span>';
    } else if (penAction == "move") {
        document.getElementById('penAction').innerHTML = '<span title="Move The last Item" class="glyphicon glyphicon-move large" id="changepenbutton"></span>';
    } else if (penAction == "rectangle") {
        document.getElementById('penAction').innerHTML = '<span class="glyphicon glyphicon glyphicon-stop large" id="changepenbutton"></span>';
    } else if (penAction == "text") {
        document.getElementById('penAction').innerHTML = '<span class="glyphicon glyphicon-text-background large" id="changepenbutton"></span>'; 
        //alert("Text is not yet supported");       
    } else if (penAction == "moveNoResizer") {
        document.getElementById('penAction').innerHTML = '<span title="Move The last Item" class="glyphicon glyphicon-move large" id="changepenbutton"></span>';
    }

    // create resizer if pen is move and delete if not
    if (penAction == "move") {
        svg.innerHTML += '<circle id="resizer" cx="0" cy="0" r="15" fill="red" stroke="white" stroke-width="2" />';
    } else {
        var resizer = document.getElementById("resizer");
        if (resizer != null) {
            resizer.remove();
        }
    }

}

function textStart() {
    let text = window.prompt("Enter Text", "");
    let textElement = "<text id='"+counter+"' x='"+currX+"' y='"+currY+"' fill='"+colour+"' font-size='"+(pensize+25)+"'>"+text+"</text>";
    svg.innerHTML += textElement;
    changePenAction("moveNoResizer");
}

function moveNoResizerStart() {
    counter--;
    if (counter < 0) {
        counter = 0;
    }
    moveStartX = currX;
    moveStartY = currY;
    imageStartX = document.getElementById(counter).getAttribute("x");
    imageStartY = document.getElementById(counter).getAttribute("y");
}

function moveNoResizerMove() {
    let item = document.getElementById(counter);
    item.setAttribute("x", parseInt(imageStartX) + (parseInt(currX) - parseInt(moveStartX)));
    item.setAttribute("y", parseInt(imageStartY) + (parseInt(currY) - parseInt(moveStartY)));
}

var rect = "";

function rectangleStart() {
    if (fillShape) {
        var rect = "<rect id='"+counter+"' x='" + currX + "' y='" + currY + "' fill='" + colour + "' stroke='" + colour + "' stroke-width='" + pensize + "' />";
    } else {
        var rect = "<rect id='"+counter+"' x='" + currX + "' y='" + currY + "' stroke='" + colour + "' stroke-width='" + pensize + "' fill='none'/>";
    }
    svg.innerHTML += rect;
}

function rectangleMove() {
    if (event.shiftKey) {
        var rectangle = document.getElementById(counter);
        if (parseInt(currX) - parseInt(rectangle.getAttribute("x")) > 0) {
            rectangle.setAttribute("width", parseInt(currX) - parseInt(rectangle.getAttribute("x")));
            rectangle.setAttribute("height", parseInt(currX) - parseInt(rectangle.getAttribute("x")));
        } else {
            rectangle.setAttribute("width", "1");
            rectangle.setAttribute("height", "1");
        }
    } else {
        var rectangle = document.getElementById(counter);
        if (parseInt(currX) - parseInt(rectangle.getAttribute("x")) > 0) {
            rectangle.setAttribute("width", parseInt(currX) - parseInt(rectangle.getAttribute("x")));
        } else {
            rectangle.setAttribute("width", "1");
        }
        if (parseInt(currY) - parseInt(rectangle.getAttribute("y")) > 0) {
            rectangle.setAttribute("height", parseInt(currY) - parseInt(rectangle.getAttribute("y")));
        } else {
            rectangle.setAttribute("height", "1");
        }
    }
}

let resizerX = 0;
let resizerY = 0;
let origonalwidth = 0;
let origonalheight = 0;


function resizerClick() {
    var resizer = document.getElementById("resizer");
    resizerX = resizer.getAttribute("cx");
    resizerY = resizer.getAttribute("cy");
    origonalwidth = document.getElementById(counter).getAttribute("width");
    origonalheight = document.getElementById(counter).getAttribute("height");
}

var moveStartX = 0;
var moveStartY = 0;
var resizeFlag = false;
var imageStartX = 0;
var imageStartY = 0;

function moveStart() {
    counter--;
    if (counter < 0) {
        counter = 0;
    }
    // check if click is within 15px of resiser
    var resizer = document.getElementById("resizer");
    var resizerX = resizer.getAttribute("cx");
    var resizerY = resizer.getAttribute("cy");
    var distance = Math.sqrt(Math.pow(currX - resizerX, 2) + Math.pow(currY - resizerY, 2));
    if (distance < 15) {
        resizeFlag = true;
        moveStartX = currX;
        moveStartY = currY;
    } else {   
        moveStartX = currX;
        moveStartY = currY;
        imageStartX = document.getElementById(counter).getAttribute("x");
        imageStartY = document.getElementById(counter).getAttribute("y");
    }
    
}

function moveMove() {
    if (resizeFlag) {
        var resizer = document.getElementById("resizer");
        var resizerX = resizer.getAttribute("cx");
        var resizerY = resizer.getAttribute("cy");
        var newX = parseInt(resizerX) + (parseInt(currX) - parseInt(moveStartX));
        var newY = parseInt(resizerY) + (parseInt(currY) - parseInt(moveStartY));
        resizer.setAttribute("cx", newX);
        resizer.setAttribute("cy", newY);
        document.getElementById(counter).setAttribute("width", parseInt(origonalwidth) + (parseInt(currX) - parseInt(moveStartX)));
        document.getElementById(counter).setAttribute("height", parseInt(origonalheight) + (parseInt(currY) - parseInt(moveStartY)));
    } else {
        let item = document.getElementById(counter);
        item.setAttribute("x", parseInt(imageStartX) + (parseInt(currX) - parseInt(moveStartX)));
        item.setAttribute("y", parseInt(imageStartY) + (parseInt(currY) - parseInt(moveStartY)));
    }
    changeImageResizerPos();
}

function circleStart() {
    if (fillShape) {
        var circle = '<circle class="createdObject" id='+counter+' cx="'+currX+'" cy="'+currY+'" r="0" stroke="'+colour+'" stroke-width="'+pensize+'" fill="'+colour+'" />';
    } else {
        var circle = '<circle id='+counter+' cx="'+currX+'" cy="'+currY+'" r="0" stroke="'+colour+'" stroke-width="'+pensize+'" fill="none" />';
    }
    //et circle = '<circle id='+counter+' cx="'+currX+'" cy="'+currY+'" r="0" stroke="'+colour+'" stroke-width="'+pensize+'" fill="none" />';
    svg.innerHTML += circle;
}

function circleMove() {
    let circle = document.getElementById(counter);
    circle.setAttribute("r", Math.sqrt(Math.pow(currX - circle.getAttribute('cx'), 2) + Math.pow(currY - circle.getAttribute('cy'), 2)));

}

function lineStart() {
    let polyline = "<polyline points='"+currX+","+currY+" "+currX+","+currY+"' style='fill:none;stroke:"+colour+";stroke-width:"+pensize+"' id='"+counter+"'></polyline>";
    svg.innerHTML += polyline;
}

function lineMove() {
    if (event.shiftKey) {
        let polygon = document.getElementById(counter);
        let points = polygon.getAttribute("points");
        // removes from the end until the last space
        points = points.substring(0, points.lastIndexOf(" "));

        let centrePoints = points.split(",");
        
        // finds the nearst point which is at a multiple of 45 degrees from the coords in points
        let x = currX;
        let y = currY;
        let centreX = parseInt(centrePoints[0]);
        let centreY = parseInt(centrePoints[1]);
        let distFromCentre = Math.sqrt(Math.pow(x-centreX, 2) + Math.pow(y-centreY, 2));
        let angle = Math.atan2(y - centreY, x - centreX) * 180 / Math.PI;
        let newAngle = Math.round(angle / 45) * 45;
        let newX = centreX + Math.cos(newAngle * Math.PI / 180) * distFromCentre;
        let newY = centreY + Math.sin(newAngle * Math.PI / 180) * distFromCentre;


        points += " "+newX+","+newY;
        // updates the points
        polygon.setAttribute("points", points);

    } else {
        let polygon = document.getElementById(counter);
        let points = polygon.getAttribute("points");
        // removes from the end until the last space
        points = points.substring(0, points.lastIndexOf(" "));
        // adds the new points to points
        points += " "+currX+","+currY;
        // updates the points
        polygon.setAttribute("points", points);
    }
}

function fillStart() {
    let polygon = "<polygon points='"+currX+","+currY+"' style='fill:"+colour+";stroke:"+colour+";stroke-width:"+pensize+"' id='"+counter+"'></polyline>";
    svg.innerHTML += polygon;
}

function fillMove() {
    let polygon = document.getElementById(counter);
    polygon.setAttribute("points", polygon.getAttribute("points")+" "+currX+","+currY);
}

function penStart() {
    if (fillShape) {
        fillStart();
    } else {
        let polyline = "<polyline points='"+currX+","+currY+"' style='fill:none;stroke:"+colour+";stroke-width:"+pensize+"' id='"+counter+"'></polyline>";
        svg.innerHTML += polyline;
    }
}

function penMove() {
    if (fillShape) {
        fillMove();
    } else {
        let polyline = document.getElementById(counter);
        polyline.setAttribute("points", polyline.getAttribute("points")+" "+currX+","+currY);
    }
}

function distance(x1, y1, x2, y2) {
    return Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
}

function KeyPress(e) {
    var evtobj = window.event? event : e
    if (evtobj.keyCode == 90 && evtobj.ctrlKey) {
        //counter--;
        if (svg.lastChild == document.getElementById("resizer")) {
            svg.removeChild(svg.lastChild);
            svg.removeChild(svg.lastChild);
            changePenAction("pen");
        } else {
            svg.removeChild(svg.lastChild);
        }
    }
}

document.onkeydown = KeyPress;

var scrollTop;
var scrollLeft;
var scrollableDiv = document.getElementById("svgholder");

function disableScroll() {
    scrollableDiv.classList.add("noScroll");
}

function enableScroll() {
    scrollableDiv.classList.remove("noScroll");
}

$(document).ready(function() {
    w = svg.width;
    h = svg.height;
    document.getElementById("pageNumber").innerHTML = "Page " + pageNumber + " of " + maxPage;
    //sets height of svg to div height
    svg.setAttribute("height", $("#svgholder").height());
    svg.setAttribute("width", $("#svgholder").width());
    defaultHeight = $("#svgholder").height();

    svg.addEventListener("pointermove", function(e) {
        e.preventDefault();
        findxy('move', e)
    }, false);
    svg.addEventListener("pointerdown", function(e) {
        e.preventDefault();
        if (e.pointerType === "pen") {
            disableScroll();
        } else {
            enableScroll();
        }
        if (e.button === 0) {
            findxy('down', e)
        }
    }, false);
    svg.addEventListener("pointerup", function(e) {
        resizeFlag = false;
        e.preventDefault();
        findxy('up', e)
        if (e.pointerType === "pen") {
            enableScroll();
        } 
    }, false);
    svg.addEventListener("touchend", function(e) {
        e.preventDefault();
    }, false);
    // Enable scroll when pointer is not on the svg
    svg.addEventListener("pointerleave", function(e) {
        enableScroll();
        if (penAction === "move" || penAction === "moveNoResizer") {
            findxy('up', e)
        }
    }, false);
});

function findxy(res, e) {
    e.preventDefault(); // prevents the default action of the event
    if (res == 'down') {
        prevX = currX;
        prevY = currY;
        currX = getX(e)
        currY = getY(e)

        flag = true;
        dot_flag = true;
        if (dot_flag) {

            if (penAction == "pen") {
                penStart();
            } else if (penAction == "fill") {
                fillStart();
            } else if (penAction == "line") {
                lineStart();
            } else if (penAction == "circle") {
                circleStart();
            } else if (penAction == "move") {
                moveStart();
            } else if (penAction == "rectangle") {
                rectangleStart();
            } else if (penAction == "text") {
                textStart();
            } else if (penAction == "moveNoResizer") {
                moveNoResizerStart();
            }

            dot_flag = false;
        }
    }
    if (res == 'up') {
        if (flag == true) {
            flag = false;
            counter++;
        }
    }
    if (res == 'move') {
        if (flag) {
            prevX = currX;
            prevY = currY;
            currX = getX(e)
            currY = getY(e)
            if (penAction == "pen") {
                penMove();
            } else if (penAction == "fill") {
                fillMove();
            } else if (penAction == "line") {
                lineMove();
            } else if (penAction == "circle") {
                circleMove();
            } else if (penAction == "move") {
                moveMove();
            } else if (penAction == "rectangle") {
                rectangleMove();
            } else if (penAction == "moveNoResizer") {
                moveNoResizerMove();
            }
        }
    }
}

function getX(e) {
    var p = svg.createSVGPoint();
    p.x = e.clientX;
    p.y = e.clientY;
    var ctm = svg.getScreenCTM().inverse();
    var p =  p.matrixTransform(ctm);
    return p.x;
}

function getY(e) {
    var p = svg.createSVGPoint();
    p.x = e.clientX;
    p.y = e.clientY;
    var ctm = svg.getScreenCTM().inverse();
    var p =  p.matrixTransform(ctm);
    return p.y;
}

function initColorPicker() {
  var canvas = document.getElementById('colorCanvas');
  var canvasContext = canvas.getContext('2d');

  let gradient = canvas.getContext('2d').createLinearGradient(0, 0, canvas.width, 0)
  gradient.addColorStop(0, '#ff0000')
  gradient.addColorStop(1 / 6, '#ffff00')
  gradient.addColorStop((1 / 6) * 2, '#00ff00')
  gradient.addColorStop((1 / 6) * 3, '#00ffff')
  gradient.addColorStop((1 / 6) * 4, '#0000ff')
  gradient.addColorStop((1 / 6) * 5, '#ff00ff')
  gradient.addColorStop(1, '#ff0000')
  canvas.getContext('2d').fillStyle = gradient
  canvas.getContext('2d').fillRect(0, 0, canvas.width, canvas.height)

  gradient = canvas.getContext('2d').createLinearGradient(0, 0, 0, canvas.height)
  gradient.addColorStop(0, 'rgba(255, 255, 255, 1)')
  gradient.addColorStop(0.5, 'rgba(255, 255, 255, 0)')
  gradient.addColorStop(1, 'rgba(255, 255, 255, 0)')
  canvas.getContext('2d').fillStyle = gradient
  canvas.getContext('2d').fillRect(0, 0, canvas.width, canvas.height)

  gradient = canvas.getContext('2d').createLinearGradient(0, 0, 0, canvas.height)
  gradient.addColorStop(0, 'rgba(0, 0, 0, 0)')
  gradient.addColorStop(0.5, 'rgba(0, 0, 0, 0)')
  gradient.addColorStop(1, 'rgba(0, 0, 0, 1)')
  canvas.getContext('2d').fillStyle = gradient
  canvas.getContext('2d').fillRect(0, 0, canvas.width, canvas.height)


  canvas.onclick = function(e) {
  	console.log()
    var imgData = canvasContext.getImageData((e.offsetX / canvas.clientWidth) * canvas.width, (e.offsetY / canvas.clientHeight) * canvas.height, 1, 1)
    var rgba = imgData.data;
    var colourGet = "rgba(" + rgba[0] + ", " + rgba[1] + ", " + rgba[2] + ", " + rgba[3] + ")";
    changePenColour(rgba2hex(colourGet));
  }
}

initColorPicker()

function rgba2hex(colour) {
    const rgba = colour.replace(/^rgba?\(|\s+|\)$/g, '').split(',');

    return `#${((1 << 24) + (parseInt(rgba[0]) << 16) + (parseInt(rgba[1]) << 8) + parseInt(rgba[2])).toString(16).slice(1)}`;
}

</script>
</html> 